
DTOP=.
BOARD=vc709
PREFIX?=/usr/local
DMAC_DIR?=../src
CONNECTALDIR?=../../connectal

BSCFLAGS_COMMON = $(BSV_FLAGS_DMAC) -D BOARD_$(BOARD)
BSCFLAGS_COMMON += +RTS -K46777216 -RTS -show-schedule
BSCPATHFLAGS=  -bdir $(DTOP)/obj -vdir $(DTOP)/verilog -simdir $(DTOP)/obj -info-dir $(DTOP)/obj
BSCFLAGS_COMMON += $(BSCWARNFLAGS) $(BSCOPTFLAGS) $(BSCPATHFLAGS) --wait-for-license

all: testdma-$(BOARD) bits

clean:
	rm -fr *.so bsim testdma-bluesim testdma-vc709 obj verilog vc709 vivado.* *.o

ConnectalProjectConfig.bsv: 
	if [ -f $(DMAC_DIR)/bsv/ConnectalProjectConfig.bsv ] ; then cp -v $(DMAC_DIR)/bsv/ConnectalProjectConfig.bsv .; fi
	if [ -f $(DMAC_DIR)/generated/ConnectalProjectConfig.bsv ] ; then cp -v $(DMAC_DIR)/generated/ConnectalProjectConfig.bsv .; fi

ifneq ($(BOARD),bluesim)
bits: mkExample.bit

run: testdma-$(BOARD) mkExample.bit
	fpgajtag mkExample.bit
	LD_LIBRARY_PATH=$(PREFIX)/lib ./testdma-$(BOARD)

mkExample.bit: verilog/mkExample.v ipcore
	rm -fr vc709
	vivado -mode batch -source impl.tcl
	cp -v vc709/vc709.runs/impl_1/mkExample.bit mkExample.bit

verilog/mkExample.v: Example.bsv ConnectalProjectConfig.bsv
	mkdir -p obj verilog
	bsc $(BSCFLAGS_COMMON) -u -g mkExample Example.bsv
	$(Q)sed -i 's|// On .*|// timestamp removed|' verilog/*.v
	$(Q)sed -i 's|  wire.*PROBE[,;]|(* mark_debug="true" *)&|' verilog/*.v 
	$(Q)sed -i 's|  wire.*PROBE_VALID[,;]|(* mark_debug="true" *)&|' verilog/*.v 
else
bits: bsim

run: testdma-$(BOARD) bsim
	PATH=.:$(PATH) LD_LIBRARY_PATH=.:../src catchsegv ./testdma-bluesim

obj/mkExample.ba: Example.bsv ConnectalProjectConfig.bsv
	mkdir -p obj verilog
	bsc $(BSCFLAGS_COMMON) -sim -u -g mkExample Example.bsv

bsim: obj/mkExample.ba
	bsc $(BSCFLAGS_COMMON) -sim -u -e mkExample -o bsim -L $(DMAC_DIR) -l dmac-bluesim obj/mkExample.ba 

endif

testdmacopy.o: testdmacopy.cpp
	g++ -O -I$(DESTDIR)$(PREFIX)/include/dmac -c testdmacopy.cpp


testdma-$(BOARD): testdmacopy.o
	g++ -O -o testdma-$(BOARD) testdmacopy.o -L$(DMAC_DIR) -ldmac-$(BOARD) -lpthread

include $(DMAC_DIR)/Makefile.dmac
